#!/usr/bin/env python3
"""
Quick test to check if Gemini is working locally vs what might be happening on Vercel
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

print("=" * 70)
print("üîç DIAGNOSING GEMINI ISSUE")
print("=" * 70)

# Test 1: Check imports
print("\n1Ô∏è‚É£ Testing imports...")
try:
    from config import Config
    print(f"   ‚úÖ Config imported")
    print(f"   ‚Ä¢ GEMINI_API_KEY present: {bool(Config.GEMINI_API_KEY)}")
    print(f"   ‚Ä¢ GEMINI_MODEL: {Config.GEMINI_MODEL}")
    print(f"   ‚Ä¢ ENABLE_GEMINI_ENHANCEMENT: {Config.ENABLE_GEMINI_ENHANCEMENT}")
except Exception as e:
    print(f"   ‚ùå Config import failed: {e}")
    sys.exit(1)

# Test 2: Check Gemini availability
print("\n2Ô∏è‚É£ Testing Gemini availability...")
try:
    from gemini_integration import GeminiCulturalAnalyzer
    print(f"   ‚úÖ GeminiCulturalAnalyzer imported")
    
    gemini = GeminiCulturalAnalyzer()
    print(f"   ‚Ä¢ is_available: {gemini.is_available}")
    print(f"   ‚Ä¢ model_name: {gemini.model_name}")
    print(f"   ‚Ä¢ base_url: {gemini.base_url}")
except Exception as e:
    print(f"   ‚ùå Gemini import/init failed: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# Test 3: Check analyzer initialization
print("\n3Ô∏è‚É£ Testing SemanticSentimentAnalyzer initialization...")
try:
    from semantic_sentiment_analyzer import SemanticSentimentAnalyzer
    analyzer = SemanticSentimentAnalyzer()
    print(f"   ‚úÖ Analyzer created")
    print(f"   ‚Ä¢ gemini_enabled: {analyzer.gemini_enabled}")
    print(f"   ‚Ä¢ gemini_analyzer exists: {analyzer.gemini_analyzer is not None}")
except Exception as e:
    print(f"   ‚ùå Analyzer init failed: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# Test 4: Quick analysis test
print("\n4Ô∏è‚É£ Testing actual analysis...")
test_text = "‡ÆØ‡Ææ‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æä‡Æ∞‡Øá ‡ÆØ‡Ææ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Æø‡Æ∞‡Øç"
try:
    result = analyzer.analyze_semantic_sentiment(test_text)
    
    is_enhanced = result.get('enhanced_analysis', False)
    meaning = result.get('semantic_analysis', {}).get('meaning', '')
    
    print(f"   ‚Ä¢ Input: {test_text}")
    print(f"   ‚Ä¢ Enhanced: {is_enhanced}")
    print(f"   ‚Ä¢ Meaning length: {len(meaning)} chars")
    print(f"   ‚Ä¢ Meaning preview: {meaning[:150]}...")
    
    if is_enhanced:
        print(f"\n   ‚úÖ GEMINI IS WORKING!")
        source_book = result.get('semantic_analysis', {}).get('source_book', '')
        if source_book:
            print(f"   ‚Ä¢ Source identified: {source_book}")
    else:
        print(f"\n   ‚ùå GEMINI NOT ACTIVATED!")
        print(f"   ‚Ä¢ This is the basic fallback meaning")
        
        # Check for error
        if result.get('gemini_error'):
            print(f"   ‚Ä¢ Gemini error: {result['gemini_error']}")
            
except Exception as e:
    print(f"   ‚ùå Analysis failed: {e}")
    import traceback
    traceback.print_exc()

print("\n" + "=" * 70)
print("DIAGNOSIS COMPLETE")
print("=" * 70)

# Summary
print("\nüìä SUMMARY:")
if analyzer.gemini_enabled and is_enhanced:
    print("‚úÖ Everything is working correctly!")
    print("‚úÖ Gemini AI is providing detailed literary analysis")
    print("‚úÖ Your deployment should work once Vercel finishes building")
elif analyzer.gemini_enabled and not is_enhanced:
    print("‚ö†Ô∏è Gemini is enabled but not being used!")
    print("   Possible reasons:")
    print("   1. API call is failing (check network/API key)")
    print("   2. Response parsing is failing")
    print("   3. Error is being silently caught")
else:
    print("‚ùå Gemini is not enabled!")
    print("   Check:")
    print("   1. ENABLE_GEMINI_ENHANCEMENT = True")
    print("   2. GEMINI_API_KEY is set")
    print("   3. gemini_integration module imports correctly")
